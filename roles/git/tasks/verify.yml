---
- name: locate git binary
  ansible.builtin.command: which git
  register: verify_git_which
  changed_when: false
  failed_when: false

- name: check if git binary exists
  ansible.builtin.stat:
    path: "{{ verify_git_which.stdout }}"
  register: verify_git_bin
  when: verify_git_which.rc == 0

- name: assert git binary is present and executable
  assert:
    that:
      - verify_git_bin.stat is defined
      - verify_git_bin.stat.exists
      - verify_git_bin.stat.executable
    fail_msg: git binary was not found in the PATH or is not executable

- name: verify .gitconfig symlink exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
    follow: false
  register: verify_gitconfig

- name: assert .gitconfig is a symlink
  assert:
    that:
      - verify_gitconfig.stat.exists
      - verify_gitconfig.stat.islnk
    fail_msg: "~/.gitconfig is missing or is not a symlink"

- name: verify .gitignore_global symlink exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.gitignore_global"
    follow: false
  register: verify_gitignore_global

- name: assert .gitignore_global is a symlink
  assert:
    that:
      - verify_gitignore_global.stat.exists
      - verify_gitignore_global.stat.islnk
    fail_msg: "~/.gitignore_global is missing or is not a symlink"

- name: verify .work.gitconfig file exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.work.gitconfig"
  register: verify_work_gitconfig

- name: assert .work.gitconfig exists with correct permissions
  assert:
    that:
      - verify_work_gitconfig.stat.exists
      - verify_work_gitconfig.stat.isreg
      - verify_work_gitconfig.stat.mode == "0700"
    fail_msg: "~/.work.gitconfig is missing or has incorrect permissions"

- name: verify work directory exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/work"
  register: verify_work_dir

- name: assert work directory exists
  assert:
    that:
      - verify_work_dir.stat.exists
      - verify_work_dir.stat.isdir
    fail_msg: "~/work directory does not exist"
