---
- name: verify rosetta 2 installation
  shell: /usr/bin/pgrep -q oahd
  register: verify_rosetta_check
  failed_when: false
  changed_when: false
  when: ansible_facts['architecture'] in ['arm64', 'aarch64']

- name: assert rosetta 2 is running
  assert:
    that:
      - verify_rosetta_check.rc == 0
    fail_msg: "Rosetta 2 (oahd process) is not running on this ARM Mac."
  when: ansible_facts['architecture'] in ['arm64', 'aarch64']

- name: locate aws cli binary
  ansible.builtin.command: which aws
  register: verify_aws_path
  changed_when: false
  failed_when: false

- name: assert aws cli is installed and in path
  assert:
    that:
      - verify_aws_path.rc == 0
    fail_msg: "AWS CLI binary was not found in the executable path."

- name: verify aws cli version
  ansible.builtin.command: aws --version
  register: verify_aws_v_output
  changed_when: false

- name: display aws cli version
  debug:
    msg: "Installed: {{ verify_aws_v_output.stdout }}"

- name: verify installer cleanup
  ansible.builtin.stat:
    path: "/tmp/AWSCLIV2.pkg"
  register: verify_aws_pkg_stat

- name: assert installer package was removed
  assert:
    that:
      - not verify_aws_pkg_stat.stat.exists
    fail_msg: "The installer package at /tmp/AWSCLIV2.pkg was not cleaned up."
