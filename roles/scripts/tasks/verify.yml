---
- name: Check scripts symlink stats
  ansible.builtin.stat:
    path: "{{ item.dest }}"
  loop: "{{ scripts_symlinks }}"
  register: scripts_verify_symlink_stats

- name: Assert symlinks are correct
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.islnk
      - item.stat.lnk_source == item.item.src
    fail_msg: "Symlink {{ item.item.dest }} is missing or points to the wrong source"
  loop: "{{ scripts_verify_symlink_stats.results }}"

- name: Locate symlinked binaries
  ansible.builtin.command: "which {{ item.dest | basename }}"
  loop: "{{ scripts_symlinks }}"
  register: scripts_verify_which
  changed_when: false
  failed_when: false

- name: Assert script binaries are present and executable
  ansible.builtin.assert:
    that:
      - item.rc == 0
    fail_msg: "Script {{ item.item.dest | basename }} was not found in the PATH"
  loop: "{{ scripts_verify_which.results }}"
