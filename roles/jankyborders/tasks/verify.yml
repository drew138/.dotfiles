---
- name: verify FelixKratz tap is present
  command: brew tap
  register: verify_borders_brew_taps
  changed_when: false

- name: assert FelixKratz tap is registered
  assert:
    that:
      - "'felixkratz/formulae' in verify_borders_brew_taps.stdout"
    fail_msg: "The FelixKratz/formulae Homebrew tap is not available."

- name: locate borders binary
  command: which borders
  register: verify_borders_which
  changed_when: false
  failed_when: false

- name: check if borders binary exists
  stat:
    path: "{{ verify_borders_which.stdout }}"
  register: verify_borders_bin
  when: verify_borders_which.rc == 0

- name: assert borders binary is present and executable
  assert:
    that:
      - verify_borders_bin.stat is defined
      - verify_borders_bin.stat.exists
      - verify_borders_bin.stat.executable
    fail_msg: "borders binary was not found in the PATH or is not executable"

- name: stat borders config symlink
  stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/borders/bordersrc"
    follow: false
  register: verify_borders_symlink

- name: assert borders config symlink is present and correct
  assert:
    that:
      - verify_borders_symlink.stat.exists
      - verify_borders_symlink.stat.islnk
      - verify_borders_symlink.stat.lnk_source ==
        ansible_facts['env']['HOME'] + '/.dotfiles/roles/borders/files/bordersrc'
    fail_msg: >-
      Borders config symlink is missing, not a symlink,
      or does not point to the expected source.
