---
- name: Verify hashicorp tap is present
  ansible.builtin.command: brew tap
  register: terraform_verify_brew_taps
  changed_when: false

- name: Assert hashicorp tap is registered
  ansible.builtin.assert:
    that:
      - "'hashicorp/tap' in terraform_verify_brew_taps.stdout"
    fail_msg: "The hashicorp/tap Homebrew tap is not available."

- name: Locate terraform binary
  ansible.builtin.command: which terraform
  register: terraform_verify_which
  changed_when: false
  failed_when: false

- name: Check if terraform binary exists
  ansible.builtin.stat:
    path: "{{ terraform_verify_which.stdout }}"
  register: terraform_verify_bin
  when: terraform_verify_which.rc == 0

- name: Assert terraform binary is present and executable
  ansible.builtin.assert:
    that:
      - terraform_verify_bin.stat is defined
      - terraform_verify_bin.stat.exists
      - terraform_verify_bin.stat.executable
    fail_msg: "terraform binary was not found in the PATH or is not executable"
