---
- name: Locate nvim binary
  ansible.builtin.command: which nvim
  register: nvim_verify_which
  changed_when: false
  failed_when: false

- name: Assert nvim is in PATH
  ansible.builtin.assert:
    that:
      - nvim_verify_which.rc == 0
      - nvim_verify_which.stdout | length > 0
    fail_msg: "nvim was not found in PATH"

- name: Verify nvim binary exists and is executable
  ansible.builtin.stat:
    path: "{{ nvim_verify_which.stdout }}"
  register: nvim_verify_bin

- name: Assert nvim binary is executable
  ansible.builtin.assert:
    that:
      - nvim_verify_bin.stat.exists
      - nvim_verify_bin.stat.executable
    fail_msg: "nvim binary exists but is not executable"

- name: Verify nvim config symlink exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
  register: nvim_verify_config

- name: Assert nvim config is a symlink
  ansible.builtin.assert:
    that:
      - nvim_verify_config.stat.exists
      - nvim_verify_config.stat.islnk
    fail_msg: "~/.config/nvim is missing or not a symlink"

- name: Verify nvim python virtualenv exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.nvimvenv/bin/activate"
  register: nvim_verify_venv

- name: Assert nvim python virtualenv exists
  ansible.builtin.assert:
    that:
      - nvim_verify_venv.stat.exists
    fail_msg: "~/.nvimvenv was not created"

- name: Verify pynvim can be imported
  ansible.builtin.command: "{{ ansible_facts['env']['HOME'] }}/.nvimvenv/bin/python -c 'import pynvim'"
  register: nvim_verify_pynvim
  changed_when: false
  failed_when: nvim_verify_pynvim.rc != 0
