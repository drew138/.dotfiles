---
- name: Locate nvim binary
  ansible.builtin.command: which nvim
  register: verify_nvim_which
  changed_when: false
  failed_when: false

- name: Assert nvim is in PATH
  ansible.builtin.assert:
    that:
      - verify_nvim_which.rc == 0
      - verify_nvim_which.stdout | length > 0
    fail_msg: "nvim was not found in PATH"

- name: Verify nvim binary exists and is executable
  ansible.builtin.stat:
    path: "{{ verify_nvim_which.stdout }}"
  register: verify_nvim_bin

- name: Assert nvim binary is executable
  ansible.builtin.assert:
    that:
      - verify_nvim_bin.stat.exists
      - verify_nvim_bin.stat.executable
    fail_msg: "nvim binary exists but is not executable"

- name: Verify nvim config symlink exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
  register: verify_nvim_config

- name: Assert nvim config is a symlink
  ansible.builtin.assert:
    that:
      - verify_nvim_config.stat.exists
      - verify_nvim_config.stat.islnk
    fail_msg: "~/.config/nvim is missing or not a symlink"

- name: Verify nvim python virtualenv exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.nvimvenv/bin/activate"
  register: verify_nvim_venv

- name: Assert nvim python virtualenv exists
  ansible.builtin.assert:
    that:
      - verify_nvim_venv.stat.exists
    fail_msg: "~/.nvimvenv was not created"

- name: Verify pynvim can be imported
  ansible.builtin.command: "{{ ansible_facts['env']['HOME'] }}/.nvimvenv/bin/python -c 'import pynvim'"
  register: verify_pynvim
  changed_when: false
  failed_when: verify_pynvim.rc != 0
