---
- name: Verify FelixKratz tap is present
  ansible.builtin.command: brew tap
  register: sketchybar_verify_brew_taps
  changed_when: false

- name: Assert FelixKratz tap is registered
  ansible.builtin.assert:
    that:
      - "'felixkratz/formulae' in sketchybar_verify_brew_taps.stdout | lower"
    fail_msg: "The FelixKratz/formulae Homebrew tap is not available."

- name: Verify required Homebrew formulae are installed
  ansible.builtin.command: brew list --formula {{ item }}
  loop:
    - sketchybar
    - lua
    - switchaudio-osx
    - nowplaying-cli
  register: sketchybar_verify_formulae
  changed_when: false
  failed_when: false

- name: Assert required Homebrew formulae are installed
  ansible.builtin.assert:
    that:
      - item.rc == 0
    fail_msg: "Required Homebrew formula '{{ item.item }}' is not installed"
  loop: "{{ sketchybar_verify_formulae.results }}"

- name: Stat sketchybar config directory
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/sketchybar"
    follow: false
  register: sketchybar_verify_config_dir

- name: Assert sketchybar config directory is a symlink to dotfiles
  ansible.builtin.assert:
    that:
      - sketchybar_verify_config_dir.stat.exists
      - sketchybar_verify_config_dir.stat.islnk
      - sketchybar_verify_config_dir.stat.lnk_source ==
        ansible_facts.env.HOME + '/.dotfiles/roles/sketchybar/files'
    fail_msg: >-
      SketchyBar config directory is missing, not a symlink,
      or does not point to the expected dotfiles location.

- name: Stat sketchybarrc inside sketchybar config
  ansible.builtin.stat:
    path: "{{ ansible_facts.env.HOME }}/.config/sketchybar/sketchybarrc"
  register: sketchybar_verify_sketchybarrc

- name: Assert sketchybarrc exists
  ansible.builtin.assert:
    that:
      - sketchybar_verify_sketchybarrc.stat.exists
      - sketchybar_verify_sketchybarrc.stat.isreg
    fail_msg: "sketchybarrc does not exist inside the sketchybar config directory"
