---
- name: Check if brew is in path
  ansible.builtin.command: which brew
  register: homebrew_verify_which
  changed_when: false
  failed_when: false

- name: Stat brew binary
  ansible.builtin.stat:
    path: "{{ homebrew_verify_which.stdout }}"
  register: homebrew_verify_bin
  when: homebrew_verify_which.rc == 0
  changed_when: false

- name: Assert brew binary exists and is executable
  ansible.builtin.assert:
    that:
      - homebrew_verify_bin is defined
      - homebrew_verify_bin.stat.exists
      - homebrew_verify_bin.stat.executable
    fail_msg: "homebrew is not installed or brew is not executable"

- name: Get homebrew version
  ansible.builtin.command: brew --version
  register: homebrew_verify_version
  changed_when: false

- name: Assert homebrew responds correctly
  ansible.builtin.assert:
    that:
      - homebrew_verify_version.stdout is search("Homebrew")
    fail_msg: "homebrew is installed but did not return a valid homebrew version"
