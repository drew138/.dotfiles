---
- name: Locate git binary
  ansible.builtin.command: which git
  register: repositories_verify_git_which
  changed_when: false
  failed_when: false

- name: Check if git binary exists
  ansible.builtin.stat:
    path: "{{ repositories_verify_git_which.stdout }}"
  register: repositories_verify_git_bin
  when: repositories_verify_git_which.rc == 0

- name: Assert git binary is present and executable
  ansible.builtin.assert:
    that:
      - repositories_verify_git_bin.stat is defined
      - repositories_verify_git_bin.stat.exists
      - repositories_verify_git_bin.stat.executable
    fail_msg: "git binary was not found in the PATH or is not executable"

- name: Check base directories and dotfiles
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ ansible_facts['env']['HOME'] }}/dev"
    - "{{ ansible_facts['env']['HOME'] }}/work"
    - "{{ ansible_facts['env']['HOME'] }}/.dotfiles"
  register: repositories_verify_base_dir_stats

- name: Assert base directories exist
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Required directory missing: {{ item.item }}"
  loop: "{{ repositories_verify_base_dir_stats.results }}"

- name: Verify repository directories
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/dev/{{ item }}"
  loop: "{{ repositories_names }}"
  register: repositories_verify_repo_dir_stats

- name: Assert repositories were cloned
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Repository directory missing: {{ item.item }}"
  loop: "{{ repositories_verify_repo_dir_stats.results }}"

- name: Verify git repository exists
  ansible.builtin.stat:
    path: "{{ item }}/.git"
  loop:
    - "{{ ansible_facts['env']['HOME'] }}/.dotfiles"
  register: repositories_verify_git_stat

- name: Assert dotfiles is a valid git repo
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Directory exists but is not a valid git repository: {{ item.item }}"
  loop: "{{ repositories_verify_git_stat.results }}"
