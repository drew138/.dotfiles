---
- name: check .local and share directory stats
  stat:
    path: "{{ item }}"
  loop:
    - "{{ ansible_facts.env.HOME }}/.local"
    - "{{ ansible_facts.env.HOME }}/.local/share"
    - "{{ zinit_home }}"
  register: zinit_dir_stats

- name: assert zinit directories exist
  assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Required directory missing: {{ item.item }}"
  loop: "{{ zinit_dir_stats.results }}"

- name: verify zinit git repository integrity
  command: "git -C {{ zinit_home }} rev-parse --is-inside-work-tree"
  register: zinit_git_check
  changed_when: false
  failed_when: false

- name: assert zinit path is a valid git repo
  assert:
    that:
      - zinit_git_check.rc == 0
    fail_msg: "The destination {{ zinit_home }} exists but is not a valid git repository"

- name: check zinit loader script
  stat:
    path: "{{ zinit_home }}/zinit.zsh"
  register: zinit_script_stat

- name: assert zinit loader is present
  assert:
    that:
      - zinit_script_stat.stat.exists
    fail_msg: "The core zinit.zsh script was not found in {{ zinit_home }}"
