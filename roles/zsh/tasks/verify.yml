---
- name: Locate zsh binary
  ansible.builtin.command: which zsh
  register: zsh_verify_which
  changed_when: false
  failed_when: false

- name: Check zsh files and symlink stats
  ansible.builtin.stat:
    path: "{{ item.path }}"
  loop:
    - path: "{{ zsh_verify_which.stdout }}"
      type: "bin"
    - path: "{{ ansible_facts['env']['HOME'] }}/.work.zsh"
      type: "file"
      mode: "0700"
    - path: "{{ ansible_facts['env']['HOME'] }}/.zshrc"
      type: "link"
  register: zsh_verify_stats
  when: zsh_verify_which.rc == 0

- name: Assert zsh binary is present
  ansible.builtin.assert:
    that:
      - zsh_verify_stats.results[0].stat.exists
      - zsh_verify_stats.results[0].stat.executable
    fail_msg: "Zsh binary was not found or is not executable"

- name: Assert .work.zsh exists with correct mode
  ansible.builtin.assert:
    that:
      - zsh_verify_stats.results[1].stat.exists
      - zsh_verify_stats.results[1].stat.mode == "0700"
    fail_msg: ".work.zsh is missing or has incorrect permissions"

- name: Assert .zshrc symlink is valid
  ansible.builtin.assert:
    that:
      - zsh_verify_stats.results[2].stat.islnk
      - zsh_verify_stats.results[2].stat.lnk_source == ansible_facts['env']['HOME'] + "/.dotfiles/roles/zsh/files/.zshrc"
    fail_msg: ".zshrc symlink is broken or pointing to the wrong source"

- name: Verify default shell for user
  ansible.builtin.shell: "dscl . -read /Users/{{ ansible_facts['env']['USER'] }} UserShell | awk '{print $2}'"
  register: zsh_verify_current_shell
  changed_when: false

- name: Assert zsh is the default shell
  ansible.builtin.assert:
    that:
      - zsh_verify_current_shell.stdout == zsh_verify_which.stdout
    fail_msg: "Default shell is {{ zsh_verify_current_shell.stdout }} but expected {{ zsh_verify_which.stdout }}"
