---
- name: locate eza binary
  ansible.builtin.command: which eza
  register: verify_eza_which
  changed_when: false
  failed_when: false

- name: check if eza binary exists
  stat:
    path: "{{ verify_eza_which.stdout }}"
  register: verify_eza_bin
  when: verify_eza_which.rc == 0

- name: assert eza binary is present and executable
  assert:
    that:
      - verify_eza_bin.stat is defined
      - verify_eza_bin.stat.exists
      - verify_eza_bin.stat.executable
    fail_msg: "Eza binary was not found in the PATH or is not executable"

- name: check dev directory and eza repo stats
  stat:
    path: "{{ item }}"
  loop:
    - "{{ ansible_facts['env']['HOME'] }}/dev/"
    - "{{ eza_home }}"
  register: verify_dir_stats

- name: assert directories and repo exist
  assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Required directory or repo missing: {{ item.item }}"
  loop: "{{ verify_dir_stats.results }}"

- name: verify eza git repository integrity
  ansible.builtin.command: git -C "{{ eza_home }}" rev-parse --is-inside-work-tree
  register: verify_eza_git_check
  changed_when: false
  failed_when: false

- name: assert eza path is a valid git repo
  assert:
    that:
      - verify_eza_git_check.rc == 0
    fail_msg: "The destination {{ eza_home }} exists but is not a valid git repository"
