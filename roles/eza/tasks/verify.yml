---
- name: Locate eza binary
  ansible.builtin.command: which eza
  register: eza_verify_which
  changed_when: false
  failed_when: false

- name: Check if eza binary exists
  ansible.builtin.stat:
    path: "{{ eza_verify_which.stdout }}"
  register: eza_verify_bin
  when: eza_verify_which.rc == 0

- name: Assert eza binary is present and executable
  ansible.builtin.assert:
    that:
      - eza_verify_bin.stat is defined
      - eza_verify_bin.stat.exists
      - eza_verify_bin.stat.executable
    fail_msg: "Eza binary was not found in the PATH or is not executable"

- name: Check dev directory and eza repo stats
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - "{{ ansible_facts['env']['HOME'] }}/dev/"
    - "{{ eza_home }}"
  register: eza_verify_dir_stats

- name: Assert directories and repo exist
  ansible.builtin.assert:
    that:
      - item.stat.exists
      - item.stat.isdir
    fail_msg: "Required directory or repo missing: {{ item.item }}"
  loop: "{{ eza_verify_dir_stats.results }}"

- name: Verify eza git repository integrity
  ansible.builtin.command: git -C "{{ eza_home }}" rev-parse --is-inside-work-tree
  register: eza_verify_git_check
  changed_when: false
  failed_when: false

- name: Assert eza path is a valid git repo
  ansible.builtin.assert:
    that:
      - eza_verify_git_check.rc == 0
    fail_msg: "The destination {{ eza_home }} exists but is not a valid git repository"
